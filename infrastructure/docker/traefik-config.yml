# Traefik v2.10 - Reverse Proxy & Load Balancer pour Architecture Mono-Tenant
# Gère le routing automatique vers les instances dédiées par sous-domaine

version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    container_name: traefik-predykt
    restart: unless-stopped
    
    ports:
      - "80:80"       # HTTP
      - "443:443"     # HTTPS
      - "8080:8080"   # Dashboard Traefik (à sécuriser en prod)
    
    command:
      # Configuration générale
      - "--api.dashboard=true"
      - "--api.insecure=true"  # À DÉSACTIVER en PROD (utiliser auth)
      
      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      
      # Entry points
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      
      # Redirection HTTP → HTTPS automatique
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      
      # SSL/TLS - Let's Encrypt automatique
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@predykt.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      
      # Wildcard SSL (recommandé pour *.predykt.com)
      - "--certificatesresolvers.letsencrypt-dns.acme.email=${ACME_EMAIL:-admin@predykt.com}"
      - "--certificatesresolvers.letsencrypt-dns.acme.storage=/letsencrypt/acme-dns.json"
      - "--certificatesresolvers.letsencrypt-dns.acme.dnschallenge=true"
      - "--certificatesresolvers.letsencrypt-dns.acme.dnschallenge.provider=${DNS_PROVIDER:-cloudflare}"
      - "--certificatesresolvers.letsencrypt-dns.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"
      
      # Logging
      - "--log.level=INFO"
      - "--log.filepath=/var/log/traefik/traefik.log"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--accesslog.format=json"
      
      # Métriques Prometheus
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.entrypoint=metrics"
      - "--entrypoints.metrics.address=:9090"
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/letsencrypt:/letsencrypt
      - ./traefik/logs:/var/log/traefik
      - ./traefik/dynamic:/etc/traefik/dynamic
    
    environment:
      # Variables pour DNS Challenge (exemple Cloudflare)
      CF_API_EMAIL: ${CLOUDFLARE_EMAIL}
      CF_API_KEY: ${CLOUDFLARE_API_KEY}
      # Ou pour Route53 (AWS)
      # AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      # AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
    
    networks:
      - traefik-public
    
    labels:
      - "traefik.enable=true"
      
      # Dashboard Traefik (À SÉCURISER EN PROD avec BasicAuth)
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.predykt.com`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      
      # Middleware de sécurité du Dashboard
      - "traefik.http.routers.traefik-dashboard.middlewares=dashboard-auth"
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH}"
      
      # Rate Limiting global
      - "traefik.http.middlewares.rate-limit.ratelimit.average=100"
      - "traefik.http.middlewares.rate-limit.ratelimit.burst=50"
      
      # Headers de sécurité globaux
      - "traefik.http.middlewares.security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.security-headers.headers.sslRedirect=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.stsPreload=true"

  # Whoami service pour tester le routing (À SUPPRIMER EN PROD)
  whoami:
    image: traefik/whoami
    container_name: whoami-test
    restart: unless-stopped
    
    networks:
      - traefik-public
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami.rule=Host(`whoami.predykt.com`)"
      - "traefik.http.routers.whoami.entrypoints=websecure"
      - "traefik.http.routers.whoami.tls.certresolver=letsencrypt"

networks:
  traefik-public:
    external: true